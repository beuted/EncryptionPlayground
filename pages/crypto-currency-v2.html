<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
        <link href="../style/main.css" rel="stylesheet">

        <script src="../vendors/jQuery-2.2.3.min.js" type="text/javascript"></script>

        <!-- Scripts comming from https://github.com/kjur/jsrsasign -->
        <script src="../vendors/jsrsasign/jsrsasign-all-min.js" type="text/javascript"></script>


        <script src="../crypto-currency-v2.js" type="text/javascript"></script>
        <script type="text/javascript">

        var network = new Network();
        var alice = new User('Alice', `-----BEGIN RSA PRIVATE KEY-----
MIICWwIBAAKBgQDRhGF7X4A0ZVlEg594WmODVVUIiiPQs04aLmvfg8SborHss5gQ
Xu0aIdUT6nb5rTh5hD2yfpF2WIW6M8z0WxRhwicgXwi80H1aLPf6lEPPLvN29EhQ
NjBpkFkAJUbS8uuhJEeKw0cE49g80eBBF4BCqSL6PFQbP9/rByxdxEoAIQIDAQAB
AoGAA9/q3Zk6ib2GFRpKDLO/O2KMnAfR+b4XJ6zMGeoZ7Lbpi3MW0Nawk9ckVaX0
ZVGqxbSIX5Cvp/yjHHpww+QbUFrw/gCjLiiYjM9E8C3uAF5AKJ0r4GBPl4u8K4bp
bXeSxSB60/wPQFiQAJVcA5xhZVzqNuF3EjuKdHsw+dk+dPECQQDubX/lVGFgD/xY
uchz56Yc7VHX+58BUkNSewSzwJRbcueqknXRWwj97SXqpnYfKqZq78dnEF10SWsr
/NMKi+7XAkEA4PVqDv/OZAbWr4syXZNv/Mpl4r5suzYMMUD9U8B2JIRnrhmGZPzL
x23N9J4hEJ+Xh8tSKVc80jOkrvGlSv+BxwJAaTOtjA3YTV+gU7Hdza53sCnSw/8F
YLrgc6NOJtYhX9xqdevbyn1lkU0zPr8mPYg/F84m6MXixm2iuSz8HZoyzwJARi2p
aYZ5/5B2lwroqnKdZBJMGKFpUDn7Mb5hiSgocxnvMkv6NjT66Xsi3iYakJII9q8C
Ma1qZvT/cigmdbAh7wJAQNXyoizuGEltiSaBXx4H29EdXNYWDJ9SS5f070BRbAIl
dqRh3rcNvpY6BKJqFapda1DjdcncZECMizT/GMrc1w==
-----END RSA PRIVATE KEY-----`, network);
        var bob = new User('Bob', `-----BEGIN RSA PRIVATE KEY-----
MIICWgIBAAKBgHJNuOcdqshauCKFhxYHUNGuIyv6H7OLtUV+Ew3ra75hWWW2fMNl
gHFwATEIg9xaDHaVmGXxdBmot78ZUeNpVYuymflwfBl06VUxSYpl7QfS5M4E9gOV
sERX/ytzRl3uuTprk/LvGwcejsVpHLlxBuVPMy6u2yPE0+X59ayLX26/AgMBAAEC
gYBI0esyklvzOJiGpbrh9dcvPll58uevYxohI6jP/WOu7iYd/pyNf2TM4CZiLqKT
B2tZQQTOLX1hu3MUc/UPhFPSybbBh4aXPYU7cBPmXz910m7PwrQZcFUETKV2Mkug
sLim1baAq++O6jUYM6RRnEcdtag3uIN/21VCevx9yTqYAQJBALSN6Nj7OFRcQfiw
ijakun2H7ldNKOXH3c8DgRTDgBrfJDmOZlcIZmQ6G10ZsROk5beRkVgHGX8G3Dia
nU2el4ECQQCiEOapzIZCLEpfG3Ay+X6FQfrkhkvrg9EECucx0GYQ6bAUgkwTiLn6
g70sKXT2E2fYvEQDB0v1t6pAHHcMWyY/AkBjmJAj+NgGuOlvPDrRj6aLjkrr/1Ub
A1gYVE+E256zs/kwgptzUN/iU6c6gOyL8H8C9ppdG3V1+5vI4Yj6AwyBAkBkCTSo
GOPCkt4xSJmADXroPGrmhnL0ZAAvk59To0RtKiIS9r6IzDuoA4tQaCKXBjFymfsN
N4LOoFkJi8h8KwM3AkBXjoieYoy6eNIKa6QRn+/6qRhO5kxdh+KFXp1svc+dg93f
/tSfi+i2Pn1Z/v7CSW9oFmFcQAwwamYlbGaBK87V
-----END RSA PRIVATE KEY-----`, network);
        var charlie = new User('Charlie', `-----BEGIN RSA PRIVATE KEY-----
MIICWwIBAAKBgHNNh/YaZnvIr58+v1MagvNjOzEg18yLVAQeZWpnNzE0qxquB2w2
eM2Rk6V9fh4WS35fatAvPfVqF/y5oZGwQ3v2ebm/AXTzrI+XCxJDRiHqsuIFRl8Z
98f0zs/NNCHtCLGqdnu0zNdL4OyA+dCeexcch6TUQklkvJRuCTUJRt9TAgMBAAEC
gYByjMMXj9DjB1Ta+0autDcGwD3tJ/jcoEr+sIgGtrZRb0bSAbUkH9XSPN+XWN5z
26hyyy7d1yFR8G4WSQGoMJpJdJH3De4RrU7ZCyx8Ln1xgk1DwoJPvOmPNcUftR5f
p3+XuuH/w6CywOtUttNgIdQeR6sIUCvgyCDHHbF5S8iMSQJBAMHKkTs9GEzK3r1s
o7Wgl/Mk4sIiAxExkD3m27IVoCWDD2QZUwLCnbaQqHQNq5GtGRRxs3ciPu4P54XU
C4RuKD8CQQCYUOu0cW229v4HVCVKeN51vbLDxdch38k9TswrQ1p3EzQuQTdxAkr4
svQGSPvyChktlCrr7Qlv9OkmOAFFdSPtAkBzxkInouNOlXCmuC3Bx5Sf1SyHkGxG
rFahNLeR1+uaHYdnZN2762rvc9K/qp8SY9h050yxYss3zFakFD9hObJfAkEAlW31
/92z/GcOStRTjV9NKAfGJGioqVPqEtqGVP9L9jwB2ksjABx2vsyZuLzLZ+ZeUyfk
f/bZZlvIjDUvkhvc9QJATDAOITmhUk/1iADjP1vqdmfVXZRdxs/iJYChQIrck0fb
hNQeR4DcAUEsr+l+d1ihUflkp+EEyyNEnpgbY0dpsw==
-----END RSA PRIVATE KEY-----`, network);

        var signedMessage;
        $(document).ready(function() {
            $('.network').click(e=> e.preventDefault());

            $('#Alice').replaceWith(alice.GetMarkup());
            $('#Bob').replaceWith(bob.GetMarkup());
            $('#Charlie').replaceWith(charlie.GetMarkup());
        });

        aliceSend1CoinToBob = function() {
            var message = alice.GetMessage("Bob", 1);
            signedMessage = alice.GetSignedMessageWithSerialNumber("Bob", 1, Date.now());
            var isOk = bob.VerifySignedMessageAndAddToBlockChain(signedMessage);
            if (isOk)
                bob.BroadcastSignedMessage(signedMessage);

            $('#transaction-block').css("display", "block");

            $('.transaction').text(JSON.stringify(message, undefined, 2));
            $('.signed-message').text(JSON.stringify(signedMessage, undefined, 2));
            $('.verify-message').text(isOk ? "valid" : "invalid");

            $('#Alice').replaceWith(alice.GetMarkup());
            $('#Bob').replaceWith(bob.GetMarkup());
            $('#Charlie').replaceWith(charlie.GetMarkup());
        }

        broadcastSameMessage = function() {
            if (!signedMessage) {
                alert('First send a legit message to be able to replay it');
                return;
            }

            bob.BroadcastSignedMessage(signedMessage);
            
            // Refresh UI
            $('#Alice').replaceWith(alice.GetMarkup());
            $('#Bob').replaceWith(bob.GetMarkup());
            $('#Charlie').replaceWith(charlie.GetMarkup());
        }

        broadcastDifferentMessages = function() {
            if (!signedMessage) {
                alert('First send a legit message to be able to replay it with a different date');
                return;
            }

            let modifiedMessage = Object.assign({}, signedMessage);
            modifiedMessage.message.date = Date.now();

            var md = new KJUR.crypto.MessageDigest({ alg: "sha256", prov: "cryptojs" });
            md.updateString(JSON.stringify(modifiedMessage));

            modifiedMessage.hash = md.digest();
            bob.BroadcastSignedMessage(modifiedMessage);
            
            // Refresh UI
            $('#Alice').replaceWith(alice.GetMarkup());
            $('#Bob').replaceWith(bob.GetMarkup());
            $('#Charlie').replaceWith(charlie.GetMarkup());
        }

        broadcastSimultaneousMessages = function() {
            bob.ComputeMoneyForKnownUsers(); // Update bob exact amount of money based on his local blockchain
            signedMessage1 = bob.GetSignedMessageWithSerialNumber("Alice", bob.money, Date.now());
            signedMessage2 = bob.GetSignedMessageWithSerialNumber("Charlie", bob.money, Date.now());

            bob.BroadcastToSpecificUser("Alice", signedMessage1);
            bob.BroadcastToSpecificUser("Charlie", signedMessage2);

            // Bob only add Alice transaction to his local blockchain
            bob.VerifySignedMessageAndAddToBlockChain(signedMessage1);

            $('#Alice').replaceWith(alice.GetMarkup());
            $('#Bob').replaceWith(bob.GetMarkup());
            $('#Charlie').replaceWith(charlie.GetMarkup());
        }

        </script>
    </head>
    <body>
        <div class="container">

            <h1 class="h1">Using serial numbers to make coins uniquely identifiable</h1>

            <p>What we’d like is a way of making potato-coins unique. They need a label or serial number. Alice would sign the message
            <i>“I, Alice, am giving Bob one potato-coin, with serial number 8740348”</i>. Then, later, Alice could sign the message <i>“I, Alice,
            am giving Bob one potato-coin, with serial number 8770431”</i>, and Bob (and everyone else) would know that a different potato-coin
            was being transferred.</p>

            <p>Something that will look like this: <code>{ "from": "Alice", "to": "Bob", "serialNumber": "8740348”" }</code></p>

            <p>To make this scheme work we need a trusted source of serial numbers for the potato-coins. <b>One way to create such a source is
            to introduce a bank</b>. This bank would provide serial numbers for potato-coins, keep track of who has which potato-coins, and verify
            that transactions really are legitimate,</p>

            <p>In more detail, let’s suppose Alice goes into the bank, and says <i>“I want to withdraw one potato-coin from my account”</i>. The
            bank reduces her account balance by one potato-coin, and assigns her a new, never-before used serial number, let’s say 1234567.
            Then, when Alice wants to transfer her potato-coin to Bob, she signs the message <i>“I, Alice, am giving Bob one potato-coin, with serial
            number 1234567”</i>. But Bob doesn’t just accept the potato-coin. Instead, he contacts the bank, and verifies that: (a) the potato-coin
            with that serial number belongs to Alice; and (b) Alice hasn’t already spent the potato-coin. If both those things are true,
            then Bob tells the bank he wants to accept the potato-coin, and the bank updates their records to show that the potato-coin with that
            serial number is now in Bob’s possession, and no longer belongs to Alice.</p>
            <br>

            <h2 class="h2">Making everyone collectively the bank</h2>

            <p>This last solution looks pretty promising. However, it turns out that we can do something much more ambitious. We can eliminate
            the bank entirely from the protocol. This changes the nature of the currency considerably. It means that there is no longer
            any single organization in charge of the currency. And when you think about the enormous power a central bank has – control
            over the money supply – that’s a pretty huge change.</p>

            <p>The idea is to make it so everyone (collectively) is the bank. In particular, we’ll assume that everyone using potato-coin keeps
            a complete record of which potato-coins belong to which person. You can think of this as a shared public ledger showing all
            potato-coin transactions. We’ll call this ledger <b>the block chain</b>.</p>

            <p>Now, suppose Alice wants to transfer an potato-coin to Bob. She signs the message <i>“I, Alice, am giving Bob one potato-coin, with
            serial number 1234567”</i>, and gives the signed message to Bob. Bob can use his copy of the block chain to check that, indeed,
            the potato-coin is Alice’s to give. If that checks out then he broadcasts both Alice’s message and his acceptance of the transaction
            to the entire network, and everyone updates their copy of the block chain.</p>

            <h2 class="h2">Where do serial number come from?</h2>

            <p>A simple idea to get this serial number would be to <b>use a hash of the message with its date</b>, so our previous messages would look 
            like this:</p>
    
            <article class="card" id="transaction-block" style="display: none;">
                <div class="card-block">
                    <ol style="margin: 0;">
                        <li><b>Transaction message:</b>
                            <code class="transaction"></code>
                        </li>

                        <li><b>Alice will then sign the message with her private key:</b>
                            <code class="signed-message"></code>
                        </li>

                        <li><b>Bob can then verify that the message is from Alice by checking the signature, that the hash is valid and that he
                        cannot be found in his local blockchain twice, he finds that it is:</b>
                            <code class="verify-message"></code>
                        </li>

                        <li><b>Bob will broadcast this message to all users, proving that he now owns +1 coin and Alice -1</b>

                        <li><b>Bob can now give Alice the potato she bought him. He can prove that Alice sent him a coin since he have a message signed with her private key</b>
                    </ol>
                </div>
            </article>

            <p><button class="btn btn-primary btn-sm" onclick="aliceSend1CoinToBob()">Make Alice send one coin to Bob 😇</button></p>            

            <p>As the transaction have been signed with Alice private key we can know for sure that Alice is okay with the transaction and since
            the hash parameter match the hash of the message and is unique on the network we can now for sure that <b>it have not been "replayed"</b></p>

            <h3>Simple double emission?</h3>
            <p><b>Previous signed transaction message:</b><code class="signed-message"></code></p>

            <p>This time Bob :</p>
            <ol>
                <li><b>cannot replay the message 10 times</b> because they will have the same hash:
                <button class="btn btn-primary btn-sm" onclick="broadcastSameMessage()">Try broadcasting the same transaction message 👿</button><br>
                </li>
                <li>and he <b>cannot change the message to change the hash</b> because the message will not be signed correctly anymore.
                <button class="btn btn-primary btn-sm" onclick="broadcastDifferentMessages()">Just change the date of the message to change its hash
                (with the same signature) 👿</button></li>
            </ol>

            <div class="alert alert-danger" role="alert">This implementation can still be abuse!</div>

            <h3>Timing attack</h3>
            <p>Great, having these hashes as serial numbers we can avoid simple double spending, but we are still weak against
            <i>"timing attacks"</i>, where malicious people spends money they don't have.</p>
            <p>Let's consider that Bob send <b>X coins</b> to Alice, (X being all the coins he has) and <b>at the exact same time</b>,
            send X coins to Charlie.</p>
            <p>What will happen is that Alice will update her local blockchain with the transaction where Bob gives her all his coins and
            Charlie will update his local blockchain with a transaction where bob gives him all his coins, and both will give bob X potatoes
            even tho' only one out of Alice and Charlie have been paid.</p>
            <p><button class="btn btn-primary btn-sm" onclick="broadcastSimultaneousMessages()">Simultaneously send two messages giving all Bob's money to Alice and Charlie 😈</button></p>
            <p>In order to avoid that we need a way to choose and validate a common version of the blockchain for all users. It means
            that we need to be able to choose if Bob have given all his coins to Alice or to Charlie.</p>
         
            <div class="row navigation">
                <div class="col-sm-12">
                    <a class="btn btn-success float-left" href="./crypto-currency.html"><< prev</a>                    
                    <a class="btn btn-success float-right" href="./crypto-currency-v3.html">next >></a>
                </div>
            </div>
        </div>

        <a class="network" href="#">
            <div id="Alice"></div>
            <div id="Bob"></div>
            <div id="Charlie"></div>
        </a>
            
    </body>
</html>
