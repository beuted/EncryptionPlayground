<html>
    <head>
        <script src="../vendors/jQuery-2.2.3.min.js" type="text/javascript"></script>

        <!-- Scripts comming from https://github.com/kjur/jsrsasign -->
        <script src="../vendors/jsrsasign/jsrsasign-all-min.js" type="text/javascript"></script>


        <script src="../crypto-currency-v2.js" type="text/javascript"></script>
        <script type="text/javascript">

        var network = new Network();
        var alice = new User('Alice', `-----BEGIN RSA PRIVATE KEY-----
MIICWwIBAAKBgQDRhGF7X4A0ZVlEg594WmODVVUIiiPQs04aLmvfg8SborHss5gQ
Xu0aIdUT6nb5rTh5hD2yfpF2WIW6M8z0WxRhwicgXwi80H1aLPf6lEPPLvN29EhQ
NjBpkFkAJUbS8uuhJEeKw0cE49g80eBBF4BCqSL6PFQbP9/rByxdxEoAIQIDAQAB
AoGAA9/q3Zk6ib2GFRpKDLO/O2KMnAfR+b4XJ6zMGeoZ7Lbpi3MW0Nawk9ckVaX0
ZVGqxbSIX5Cvp/yjHHpww+QbUFrw/gCjLiiYjM9E8C3uAF5AKJ0r4GBPl4u8K4bp
bXeSxSB60/wPQFiQAJVcA5xhZVzqNuF3EjuKdHsw+dk+dPECQQDubX/lVGFgD/xY
uchz56Yc7VHX+58BUkNSewSzwJRbcueqknXRWwj97SXqpnYfKqZq78dnEF10SWsr
/NMKi+7XAkEA4PVqDv/OZAbWr4syXZNv/Mpl4r5suzYMMUD9U8B2JIRnrhmGZPzL
x23N9J4hEJ+Xh8tSKVc80jOkrvGlSv+BxwJAaTOtjA3YTV+gU7Hdza53sCnSw/8F
YLrgc6NOJtYhX9xqdevbyn1lkU0zPr8mPYg/F84m6MXixm2iuSz8HZoyzwJARi2p
aYZ5/5B2lwroqnKdZBJMGKFpUDn7Mb5hiSgocxnvMkv6NjT66Xsi3iYakJII9q8C
Ma1qZvT/cigmdbAh7wJAQNXyoizuGEltiSaBXx4H29EdXNYWDJ9SS5f070BRbAIl
dqRh3rcNvpY6BKJqFapda1DjdcncZECMizT/GMrc1w==
-----END RSA PRIVATE KEY-----`, network);
        var bob = new User('Bob', `-----BEGIN RSA PRIVATE KEY-----
MIICWgIBAAKBgHJNuOcdqshauCKFhxYHUNGuIyv6H7OLtUV+Ew3ra75hWWW2fMNl
gHFwATEIg9xaDHaVmGXxdBmot78ZUeNpVYuymflwfBl06VUxSYpl7QfS5M4E9gOV
sERX/ytzRl3uuTprk/LvGwcejsVpHLlxBuVPMy6u2yPE0+X59ayLX26/AgMBAAEC
gYBI0esyklvzOJiGpbrh9dcvPll58uevYxohI6jP/WOu7iYd/pyNf2TM4CZiLqKT
B2tZQQTOLX1hu3MUc/UPhFPSybbBh4aXPYU7cBPmXz910m7PwrQZcFUETKV2Mkug
sLim1baAq++O6jUYM6RRnEcdtag3uIN/21VCevx9yTqYAQJBALSN6Nj7OFRcQfiw
ijakun2H7ldNKOXH3c8DgRTDgBrfJDmOZlcIZmQ6G10ZsROk5beRkVgHGX8G3Dia
nU2el4ECQQCiEOapzIZCLEpfG3Ay+X6FQfrkhkvrg9EECucx0GYQ6bAUgkwTiLn6
g70sKXT2E2fYvEQDB0v1t6pAHHcMWyY/AkBjmJAj+NgGuOlvPDrRj6aLjkrr/1Ub
A1gYVE+E256zs/kwgptzUN/iU6c6gOyL8H8C9ppdG3V1+5vI4Yj6AwyBAkBkCTSo
GOPCkt4xSJmADXroPGrmhnL0ZAAvk59To0RtKiIS9r6IzDuoA4tQaCKXBjFymfsN
N4LOoFkJi8h8KwM3AkBXjoieYoy6eNIKa6QRn+/6qRhO5kxdh+KFXp1svc+dg93f
/tSfi+i2Pn1Z/v7CSW9oFmFcQAwwamYlbGaBK87V
-----END RSA PRIVATE KEY-----`, network, );
        var charlie = new User('Charlie', `-----BEGIN RSA PRIVATE KEY-----
MIICWwIBAAKBgHNNh/YaZnvIr58+v1MagvNjOzEg18yLVAQeZWpnNzE0qxquB2w2
eM2Rk6V9fh4WS35fatAvPfVqF/y5oZGwQ3v2ebm/AXTzrI+XCxJDRiHqsuIFRl8Z
98f0zs/NNCHtCLGqdnu0zNdL4OyA+dCeexcch6TUQklkvJRuCTUJRt9TAgMBAAEC
gYByjMMXj9DjB1Ta+0autDcGwD3tJ/jcoEr+sIgGtrZRb0bSAbUkH9XSPN+XWN5z
26hyyy7d1yFR8G4WSQGoMJpJdJH3De4RrU7ZCyx8Ln1xgk1DwoJPvOmPNcUftR5f
p3+XuuH/w6CywOtUttNgIdQeR6sIUCvgyCDHHbF5S8iMSQJBAMHKkTs9GEzK3r1s
o7Wgl/Mk4sIiAxExkD3m27IVoCWDD2QZUwLCnbaQqHQNq5GtGRRxs3ciPu4P54XU
C4RuKD8CQQCYUOu0cW229v4HVCVKeN51vbLDxdch38k9TswrQ1p3EzQuQTdxAkr4
svQGSPvyChktlCrr7Qlv9OkmOAFFdSPtAkBzxkInouNOlXCmuC3Bx5Sf1SyHkGxG
rFahNLeR1+uaHYdnZN2762rvc9K/qp8SY9h050yxYss3zFakFD9hObJfAkEAlW31
/92z/GcOStRTjV9NKAfGJGioqVPqEtqGVP9L9jwB2ksjABx2vsyZuLzLZ+ZeUyfk
f/bZZlvIjDUvkhvc9QJATDAOITmhUk/1iADjP1vqdmfVXZRdxs/iJYChQIrck0fb
hNQeR4DcAUEsr+l+d1ihUflkp+EEyyNEnpgbY0dpsw==
-----END RSA PRIVATE KEY-----`, network);

        var signedMessage;
        $(document).ready(function() {
            aliceSend1CoinToBob();
        });

        aliceSend1CoinToBob = function() {
            var message = alice.GetMessage("Bob", 1);
            signedMessage = alice.GetSignedMessageWithSerialNumber("Bob", 1, Date.now());
            var isOk = bob.VerifySignedMessageAndAddToBlockChain(signedMessage);
            if (isOk)
                bob.BroadcastSignedMessage(signedMessage);

            $('.transaction').text(JSON.stringify(message, undefined, 2));
            $('.signed-message').text(JSON.stringify(signedMessage, undefined, 2));
            $('.verify-message').text(isOk);
            $('#Alice').replaceWith(alice.GetMarkup());
            $('#Bob').replaceWith(bob.GetMarkup());
            $('#Charlie').replaceWith(charlie.GetMarkup());
        }

        broadcastSameMessage = function() {
            bob.BroadcastSignedMessage(signedMessage);
            
            // Refresh UI
            $('#Alice').replaceWith(alice.GetMarkup());
            $('#Bob').replaceWith(bob.GetMarkup());
            $('#Charlie').replaceWith(charlie.GetMarkup());
        }

        broadcastDifferentMessage = function() {
            let modifiedMessage = Object.assign({}, signedMessage);
            modifiedMessage.message.date = Date.now();

            var md = new KJUR.crypto.MessageDigest({ alg: "sha256", prov: "cryptojs" });
            md.updateString(JSON.stringify(modifiedMessage));

            modifiedMessage.hash = md.digest();
            bob.BroadcastSignedMessage(modifiedMessage);
            
            // Refresh UI
            $('#Alice').replaceWith(alice.GetMarkup());
            $('#Bob').replaceWith(bob.GetMarkup());
            $('#Charlie').replaceWith(charlie.GetMarkup());
        }

        </script>
        <style>
            .user {
                display: inline-block;
                width: 400px;
                vertical-align: top;
                margin: 10px;
                padding: 10px;
                font-family: monospace;
                background-color: #d4d6ff;
            }

            .user>h2 {
                margin-top: 3px;
                margin-bottom: 3px;
            }

            .user .hover-to-see {
                cursor: pointer;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 50ch;
                white-space: nowrap;
            }

            .user .hover-to-see:hover {
                text-overflow: inherit;
                width: inherit;
                white-space: normal;
            }
        </style>
    </head>
    <body>
        <h1>Crypto-currency v2 (block-chain)</h1>
        <div>(Non-minified source-code for you to look, also have a look at this <a href="http://www.michaelnielsen.org/ddi/how-the-bitcoin-protocol-actually-works/">How The Bitcoin Protocol Actually Works/</a>)</div>
        <a href="./crypto-currency.html"><< prev</a><br><br>

        <h2><b>Step 2:</b> Using serial numbers to make coins uniquely identifiable</h2>

        <p>What we‚Äôd like is a way of making infocoins unique. They need a label or serial number. Alice would sign the message
        ‚ÄúI, Alice, am giving Bob one infocoin, with serial number 8740348‚Äù. Then, later, Alice could sign the message ‚ÄúI, Alice,
        am giving Bob one infocoin, with serial number 8770431‚Äù, and Bob (and everyone else) would know that a different infocoin
        was being transferred.</p>

        <p>To make this scheme work we need a trusted source of serial numbers for the infocoins. One way to create such a source is
        to introduce a bank. This bank would provide serial numbers for infocoins, keep track of who has which infocoins, and verify
        that transactions really are legitimate,</p>

        <p>In more detail, let‚Äôs suppose Alice goes into the bank, and says ‚ÄúI want to withdraw one infocoin from my account‚Äù. The
        bank reduces her account balance by one infocoin, and assigns her a new, never-before used serial number, let‚Äôs say 1234567.
        Then, when Alice wants to transfer her infocoin to Bob, she signs the message ‚ÄúI, Alice, am giving Bob one infocoin, with serial
        number 1234567‚Äù. But Bob doesn‚Äôt just accept the infocoin. Instead, he contacts the bank, and verifies that: (a) the infocoin
        with that serial number belongs to Alice; and (b) Alice hasn‚Äôt already spent the infocoin. If both those things are true,
        then Bob tells the bank he wants to accept the infocoin, and the bank updates their records to show that the infocoin with that
        serial number is now in Bob‚Äôs possession, and no longer belongs to Alice.</p>

        <h2>Making everyone collectively the bank</h2>

        <p>This last solution looks pretty promising. However, it turns out that we can do something much more ambitious. We can eliminate
        the bank entirely from the protocol. This changes the nature of the currency considerably. It means that there is no longer
        any single organization in charge of the currency. And when you think about the enormous power a central bank has ‚Äì control
        over the money supply ‚Äì that‚Äôs a pretty huge change.</p>

        <p>The idea is to make it so everyone (collectively) is the bank. In particular, we‚Äôll assume that everyone using Infocoin keeps
        a complete record of which infocoins belong to which person. You can think of this as a shared public ledger showing all
        Infocoin transactions. We‚Äôll call this ledger the block chain, since that‚Äôs what the complete record will be called in Bitcoin,
        once we get to it.</p>

        <p>Now, suppose Alice wants to transfer an infocoin to Bob. She signs the message ‚ÄúI, Alice, am giving Bob one infocoin, with
        serial number 1234567‚Äù, and gives the signed message to Bob. Bob can use his copy of the block chain to check that, indeed,
        the infocoin is Alice‚Äôs to give. If that checks out then he broadcasts both Alice‚Äôs message and his acceptance of the transaction
        to the entire network, and everyone updates their copy of the block chain.</p>

        <h2>Where do serial number come from ?</h2>

        <p>A simple idea to get this serial number would be to use a hash of the message with its date, so our previous messages would look 
        like this.</p>
  
        <ol>
            <li><b>Transaction message:</b>
<code class="transaction"></code>
            </li>

            <li><b>Alice will then sign the message with her private key:</b>
<code class="signed-message"></code>
            </li>

            <li><b>Bob can then verify that the message is from Alice by checking the signature, check that the hash is valid and that he
            cannot be found in his local blockchain, he finds that is is:</b>
<code class="verify-message"></code>
            </li>

            <li><b>Bob will broadcast this message to all users proving that he now owns +1 coin and Alice -1</b>

            <li><b>Bob can now give Alice the potato she bought him. He can prove that Alice sent him a coin since he have a message signed with her private key</b>
        </ol>

        <p>As the transaction have been signed with Alice private key we can know for sure that Alice is okay with the transaction and since
        the hash parameter match the hash of the message and is unique on the network we can now for sure that it have not been "replayed":
        If this encrypted transaction is broadcasted on the network everybody will be aware that Bob now have +1 coin and Alice -1 coin.</p>
        <button onclick="aliceSend1CoinToBob()">Make Alice send one coin to Bob üòá</button>

        <p>State of the network</p>
        <div id="Alice"></div>
        <div id="Bob"></div>
        <div id="Charlie"></div>
        
        <p>This implementation can be abuse in an easy way</p>
        <p><b>Simple double emission</b>: Bob could replay the same transaction on the network and steal all Alice money!</p>
        <ol>
            <li><b>Previous signed transaction message:</b>
<code class="signed-message"></code>
            </li>

            <li><b>This time Bob cannot replay the message 10 times</b> because they will have the same hash:
            <button onclick="broadcastSameMessage()">Try broadcasting the same transaction message üëø</button><br>
            and he cannot change the message to change the hash because the message will not be signed correctly anymore.
            <button onclick="broadcastDifferentMessage()">Just change the date of the message to change its hash
            (with the same signature) üëø</button>
        </ol>

        <p>Great, having these hashes as serial numbers we can avoid double spending</p>

        <p>We'll need a way to avoid simple double spending <a href="./crypto-currency-v3.html">next >></a></p>
    </body>
</html>
